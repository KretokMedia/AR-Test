<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR Place Screen - Rotate Only (Deadzone)</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>

    <style>
      body { margin: 0; overflow: hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }

      #overlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        pointer-events: none;
      }

      #deadzone {
        position: absolute;
        left: 0; right: 0; bottom: 0;
        height: 200px;
        pointer-events: auto;
        background: rgba(0,0,0,0);
        display: none;
        touch-action: none;
      }

      #hint {
        position: absolute;
        left: 0; right: 0; bottom: 210px;
        text-align: center;
        color: white;
        font-size: 13px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.6);
        display: none;
        pointer-events: none;
      }

      #ui {
        position: absolute;
        left: 0; right: 0; bottom: 0;
        padding: 12px 10px;
        display: none;
        gap: 10px;
        justify-content: center;
        align-items: center;
        pointer-events: none;
      }

      .btn {
        pointer-events: auto;
        border: 0;
        padding: 10px 14px;
        border-radius: 999px;
        background: rgba(0,0,0,0.65);
        color: white;
        font-size: 14px;
        user-select: none;
        -webkit-user-select: none;
        touch-action: none; /* IMPORTANT: stops browser gestures interfering */
      }

      /* Optional tiny debug bubble (shows last action) */
      #debug {
        position: absolute;
        top: 10px;
        left: 10px;
        padding: 6px 10px;
        border-radius: 10px;
        background: rgba(0,0,0,0.55);
        color: #fff;
        font-size: 12px;
        display: none;
        pointer-events: none;
      }
    </style>
  </head>

  <body>
    <div id="overlay">
      <div id="deadzone"></div>
      <div id="hint">Tap ABOVE the buttons to place/move. Hold buttons to rotate.</div>

      <div id="ui">
        <button id="rotLeft" class="btn">↺ Rotate</button>
        <button id="rotRight" class="btn">Rotate ↻</button>
      </div>

      <div id="debug"></div>
    </div>

    <a-scene
      xr-mode-ui="XRMode: ar"
      renderer="antialias: false; precision: mediump; colorManagement: true"
      webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: #overlay"
      ar-hit-test="target: #screen; enabled: true"
      vr-mode-ui="enabled: false">

      <a-entity id="screen" visible="false" scale="0.3 0.3 0.3">
        <a-entity id="yaw" rotation="0 0 0">
          <a-entity id="model" gltf-model="screen.glb" rotation="0 180 0"></a-entity>
        </a-entity>
      </a-entity>

      <a-camera></a-camera>
    </a-scene>

    <script>
      const sceneEl  = document.querySelector("a-scene");
      const screenEl = document.querySelector("#screen");
      const yawEl    = document.querySelector("#yaw");

      const ui = document.getElementById("ui");
      const hint = document.getElementById("hint");
      const deadzone = document.getElementById("deadzone");
      const debug = document.getElementById("debug");

      const rotLeft  = document.getElementById("rotLeft");
      const rotRight = document.getElementById("rotRight");

      let placed = false;
      let inAR = false;

      const isVisibleTrue = (v) => v === true || v === "true";

      function showOverlayUI() {
        if (!inAR) return;
        ui.style.display = "flex";
        hint.style.display = "block";
        deadzone.style.display = "block";
        // debug.style.display = "block"; // uncomment if you want debug always visible
      }

      function hideOverlayUI() {
        ui.style.display = "none";
        hint.style.display = "none";
        deadzone.style.display = "none";
        debug.style.display = "none";
      }

      function setHitTestEnabled(enabled) {
        sceneEl.setAttribute("ar-hit-test", { target: "#screen", enabled });
      }

      sceneEl.addEventListener("enter-vr", () => { inAR = true; showOverlayUI(); });
      sceneEl.addEventListener("exit-vr",  () => { inAR = false; hideOverlayUI(); });

      const obs = new MutationObserver(() => {
        placed = isVisibleTrue(screenEl.getAttribute("visible"));
        if (placed && inAR) showOverlayUI();
      });
      obs.observe(screenEl, { attributes: true, attributeFilter: ["visible"] });

      function swallow(e) {
        if (!e) return;
        e.preventDefault?.();
        e.stopPropagation?.();
      }

      function lockPlacement(e) {
        swallow(e);
        setHitTestEnabled(false);
      }

      function unlockPlacement(e) {
        swallow(e);
        setTimeout(() => setHitTestEnabled(true), 140);
      }

      // Deadzone blocks placement/move
      ["touchstart","mousedown"].forEach(evt =>
        deadzone.addEventListener(evt, lockPlacement, { passive: false })
      );
      ["touchend","touchcancel","mouseup","mouseleave"].forEach(evt =>
        deadzone.addEventListener(evt, unlockPlacement, { passive: false })
      );

      // -------- ROTATION (hold-to-rotate) --------
      let rotTimer = null;

      function rotateStep(dir) {
        if (!placed) return;
        const r = yawEl.getAttribute("rotation") || { x: 0, y: 0, z: 0 };
        yawEl.setAttribute("rotation", { x: r.x, y: r.y + dir * 2.5, z: r.z });
      }

      function startRotate(dir) {
        if (!placed) return;
        stopRotate();
        rotateStep(dir); // immediate
        rotTimer = setInterval(() => rotateStep(dir), 16);
      }

      function stopRotate() {
        if (rotTimer) clearInterval(rotTimer);
        rotTimer = null;
      }

      function setDebug(text) {
        // optional debug - helps confirm button events are firing in AR
        debug.style.display = "block";
        debug.textContent = text;
        clearTimeout(setDebug._t);
        setDebug._t = setTimeout(() => (debug.style.display = "none"), 800);
      }

      function bindHoldRotate(btn, dir, label) {
        // Touch (mobile AR)
        btn.addEventListener("touchstart", (e) => {
          lockPlacement(e);
          setDebug(label + " touchstart");
          startRotate(dir);
        }, { passive: false });

        btn.addEventListener("touchend", (e) => {
          setDebug(label + " touchend");
          stopRotate();
          unlockPlacement(e);
        }, { passive: false });

        btn.addEventListener("touchcancel", (e) => {
          setDebug(label + " touchcancel");
          stopRotate();
          unlockPlacement(e);
        }, { passive: false });

        // Mouse (desktop testing)
        btn.addEventListener("mousedown", (e) => {
          lockPlacement(e);
          setDebug(label + " mousedown");
          startRotate(dir);
        }, { passive: false });

        btn.addEventListener("mouseup", (e) => {
          setDebug(label + " mouseup");
          stopRotate();
          unlockPlacement(e);
        }, { passive: false });

        btn.addEventListener("mouseleave", (e) => {
          stopRotate();
        }, { passive: false });

        // Click fallback (some browsers only deliver click)
        btn.addEventListener("click", (e) => {
          swallow(e);
          setDebug(label + " click");
          // single step rotate on click
          rotateStep(dir);
        }, { passive: false });
      }

      bindHoldRotate(rotLeft, -1, "LEFT");
      bindHoldRotate(rotRight, +1, "RIGHT");

      // Safety: stop rotation if finger lifts anywhere
      window.addEventListener("touchend", stopRotate, { passive: true });
      window.addEventListener("mouseup", stopRotate, { passive: true });
      window.addEventListener("touchcancel", stopRotate, { passive: true });
    </script>
  </body>
</html>
