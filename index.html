<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR Place Screen - Rotate & Scale</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>

    <style>
      body { margin: 0; overflow: hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }

      /* DOM Overlay container (stays visible in AR) */
      #overlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        pointer-events: none; /* taps go to AR except on buttons */
      }

      #hint {
        position: absolute;
        left: 0; right: 0; bottom: 70px;
        text-align: center;
        color: white;
        font-size: 13px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.6);
        display: none;
        pointer-events: none;
      }

      #ui {
        position: absolute;
        left: 0; right: 0; bottom: 0;
        padding: 12px 10px;
        display: none;
        gap: 10px;
        justify-content: center;
        align-items: center;
        pointer-events: none;
      }

      .btn {
        pointer-events: auto; /* buttons clickable */
        border: 0;
        padding: 10px 14px;
        border-radius: 999px;
        background: rgba(0,0,0,0.65);
        color: white;
        font-size: 14px;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }

      .btn.small { padding: 10px 16px; font-weight: 800; }
    </style>
  </head>

  <body>
    <!-- DOM Overlay -->
    <div id="overlay">
      <div id="hint">Tap the floor to move. Use buttons to rotate/scale.</div>

      <div id="ui">
        <button id="rotLeft" class="btn">↺ Rotate</button>
        <button id="rotRight" class="btn">Rotate ↻</button>
        <button id="minusBtn" class="btn small">−</button>
        <button id="plusBtn" class="btn small">+</button>
      </div>
    </div>

    <a-scene
      xr-mode-ui="XRMode: ar"
      renderer="antialias: false; precision: mediump; colorManagement: true"
      webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: #overlay"
      ar-hit-test="target: #screen;"
      vr-mode-ui="enabled: false">

      <a-entity
        id="screen"
        gltf-model="screen.glb"
        visible="false"
        scale="0.08 0.08 0.08">
      </a-entity>

      <a-camera></a-camera>
    </a-scene>

    <script>
      const sceneEl  = document.querySelector("a-scene");
      const screenEl = document.querySelector("#screen");

      const ui   = document.getElementById("ui");
      const hint = document.getElementById("hint");

      const plusBtn  = document.getElementById("plusBtn");
      const minusBtn = document.getElementById("minusBtn");
      const rotLeft  = document.getElementById("rotLeft");
      const rotRight = document.getElementById("rotRight");

      let placed = false;
      let inAR = false;

      const showUI = () => {
        // Show controls only when AR session is active
        if (!inAR) return;
        ui.style.display = "flex";
        hint.style.display = "block";
      };

      const hideUI = () => {
        ui.style.display = "none";
        hint.style.display = "none";
      };

      // ---- Detect AR session start/end (so UI only appears on camera screen)
      sceneEl.addEventListener("enter-vr", () => {
        // A-Frame fires enter-vr for XR sessions (AR or VR). We are forcing XRMode: ar.
        inAR = true;
        showUI();
      });

      sceneEl.addEventListener("exit-vr", () => {
        inAR = false;
        hideUI();
      });

      // ---- Detect placement (model becomes visible)
      const isVisibleTrue = (v) => v === true || v === "true";

      const obs = new MutationObserver(() => {
        const v = screenEl.getAttribute("visible");
        placed = isVisibleTrue(v);
        // If placed and we’re in AR, ensure UI is visible
        if (placed && inAR) showUI();
      });
      obs.observe(screenEl, { attributes: true, attributeFilter: ["visible"] });

      // ---- IMPORTANT: stop button taps from bubbling into the AR "select" placement
      const stopEvent = (e) => {
        e.preventDefault();
        e.stopPropagation();
      };

      // Only block events on BUTTONS (not the whole UI container)
      const blockOnButton = (btn) => {
        ["pointerdown","pointerup","click","touchstart","touchend"].forEach(evt => {
          btn.addEventListener(evt, stopEvent, { passive: false });
        });
      };
      [rotLeft, rotRight, plusBtn, minusBtn].forEach(blockOnButton);

      // ---- Scale controls
      const clamp = (v, min, max) => Math.min(max, Math.max(min, v));

      function scaleBy(factor) {
        if (!placed) return; // don’t scale before it’s placed
        const s = screenEl.object3D.scale.x;
        const next = clamp(s * factor, 0.02, 3.0);
        screenEl.object3D.scale.set(next, next, next);
      }

      plusBtn.addEventListener("pointerup", (e) => { stopEvent(e); scaleBy(1.15); }, { passive: false });
      minusBtn.addEventListener("pointerup", (e) => { stopEvent(e); scaleBy(0.87); }, { passive: false });

      // ---- Rotate controls (press & hold)
      let rotTimer = null;

      function startRotate(dir) {
        if (!placed) return;
        stopRotate();
        rotTimer = setInterval(() => {
          screenEl.object3D.rotation.y += dir * 0.05;
        }, 16);
      }
      function stopRotate() {
        if (rotTimer) clearInterval(rotTimer);
        rotTimer = null;
      }

      rotLeft.addEventListener("pointerdown", (e) => { stopEvent(e); startRotate(-1); }, { passive: false });
      rotRight.addEventListener("pointerdown", (e) => { stopEvent(e); startRotate(+1); }, { passive: false });

      window.addEventListener("pointerup", stopRotate);
      window.addEventListener("pointercancel", stopRotate);

      // Optional quick nudge on tap
      rotLeft.addEventListener("pointerup", (e) => { stopEvent(e); if (placed) screenEl.object3D.rotation.y -= 0.25; }, { passive: false });
      rotRight.addEventListener("pointerup", (e) => { stopEvent(e); if (placed) screenEl.object3D.rotation.y += 0.25; }, { passive: false });

      // ---- Safety: if you already placed the model before UI shows, show UI once inAR becomes true
      // (handled by enter-vr -> showUI)
    </script>
  </body>
</html>
